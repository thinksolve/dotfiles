#!/bin/sh
REAL_NVIM=/run/current-system/sw/bin/nvim
RECENT_DB=${RECENT_DB:-${XDG_DATA_HOME:-$HOME/.local/share}/shell_recent}
MAX=75

# first real file/dir argument
for arg; do [ -e "$arg" ] && FILE=$(realpath "$arg") && break; done

# # atomic deduping write (keeps old)
# if [ -n "$FILE" ]; then
#   tmp=$(mktemp) || exit 1
#   {
#     [ -f "$RECENT_DB" ] && cat "$RECENT_DB"
#     echo "$FILE"
#   } |
#     awk '!seen[$0]++' | tail -n "$MAX" >"$tmp" && mv "$tmp" "$RECENT_DB"
# fi

# # atomic deduping write (keeps latest)
if [ -n "$FILE" ]; then
  tmp=$(mktemp) || exit 1
  # 1. copy everything except the duplicate
  [ -f "$RECENT_DB" ] && grep -Fxv "$FILE" "$RECENT_DB" >"$tmp"
  # 2. append the new hit â†’ now at bottom
  echo "$FILE" >>"$tmp"
  # 3. keep only MAX lines (trim from the top, preserve order)
  tail -n "$MAX" "$tmp" >"$tmp.2" && mv "$tmp.2" "$RECENT_DB"
  rm -f "$tmp"
fi

exec "$REAL_NVIM" "$@"
