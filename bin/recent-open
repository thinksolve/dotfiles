#!/usr/bin/env bash

# run-and-log  [--yazi]  path  [extra-args...]
set -e

REAL_NVIM=$HOME/.nix-profile/bin/nvim
REAL_YAZI=$HOME/.nix-profile/bin/yazi
RECENT_DB=${RECENT_DB:-${XDG_DATA_HOME:-$HOME/.local/share}/shell_recent}
MAX=75

# ---- pick launcher -------------------------------------------------
RUNNER="" # start empty
if [[ ${1:-} == --yazi ]]; then
    RUNNER=$REAL_YAZI
    shift
elif [[ ${1:-} == --nvim ]]; then
    RUNNER=$REAL_NVIM
    shift
fi

editable_path() {
    local p=$1
    [[ -d $p ]] && return 0
    case $(file --mime-type -b -- "$p") in
    text/* | application/json | application/x-yaml | application/xml | application/x-shellscript) return 0 ;;
    esac
    return 1
}

# ---- auto-detect if no override -----------------------------------
if [[ -z $RUNNER ]]; then
    if [[ -d ${1:-} ]]; then
        RUNNER=$REAL_YAZI
    elif editable_path "$1"; then
        RUNNER=$REAL_NVIM
    else
        RUNNER=open
    fi
fi

# ---- log the first existing argument -------------------------------
for arg; do
    [[ -e $arg ]] && TARGET=$(realpath "$arg") && break
done

if [[ -n ${TARGET:-} ]]; then
    tmp=$(mktemp)
    [[ -f $RECENT_DB ]] && grep -Fxv "$TARGET" "$RECENT_DB" >"$tmp" || true
    printf '%s\n' "$TARGET" >>"$tmp"
    tail -n "$MAX" "$tmp" >"$tmp.2" && mv "$tmp.2" "$RECENT_DB"
    rm -f "$tmp"
fi

exec "$RUNNER" "$@"
